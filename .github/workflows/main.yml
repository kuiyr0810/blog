name: è‡ªåŠ¨éƒ¨ç½² Hexo

on:
  push:
    branches:
      - master # ä½ çš„åšå®¢æºä»£ç åˆ†æ”¯

  # release äº‹ä»¶è§¦å‘çš„åœºæ™¯ï¼Œéœ€è¦æ ¹æ®å®é™…éœ€æ±‚ç¡®è®¤é€»è¾‘ã€‚
  # å¯¹äº Hexo åšå®¢éƒ¨ç½²ï¼Œé€šå¸¸åªç›‘å¬ push äº‹ä»¶åˆ°æºåˆ†æ”¯å°±è¶³å¤Ÿäº†ã€‚
  # å¦‚æœä½ çš„ release æ˜¯è§¦å‘åšå®¢å½’æ¡£æˆ–å…¶ä»–ç‹¬ç«‹å†…å®¹çš„ï¼Œä¿ç•™å³å¯ã€‚
  release:
    types:
      - published

jobs:
  deploy:
    # å§‹ç»ˆä½¿ç”¨æœ€æ–°çš„ LTS runnerï¼Œä»¥è·å¾—æœ€æ–°çš„ Git å’Œ OS ç‰ˆæœ¬
    runs-on: ubuntu-latest
    
    # å®šä¹‰ç¯å¢ƒç§˜å¯†å˜é‡
    env:
      TZ: 'Asia/Shanghai' # å°†æ—¶åŒºè®¾ç½®æ”¾åˆ°å…¨å±€ env ä¸­ï¼Œæ–¹ä¾¿æ‰€æœ‰ run å‘½ä»¤ç»§æ‰¿
      
    steps:
      - name: â¬‡ï¸ Checkout source code # ä½¿ç”¨æœ€æ–°ç‰ˆ checkout
        uses: actions/checkout@v4
        with:
          # `master` æˆ– `main` å–å†³äºä½ ä»“åº“çš„å®é™…åˆ†æ”¯åã€‚
          # é€šå¸¸ï¼Œcheckout é»˜è®¤ä¼šæ£€å‡ºè§¦å‘å·¥ä½œæµçš„åˆ†æ”¯ï¼Œè¿™é‡Œå¯ä»¥ä¸å¼ºåˆ¶æŒ‡å®š `ref`
          # å¦‚æœä½ çš„ä»“åº“ä¸»åˆ†æ”¯æ˜¯ masterï¼Œå¯ä»¥ä¿ç•™ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™å»é™¤æˆ–æ”¹ä¸ºå¯¹åº”åç§°ã€‚
          ref: master
          # ä¸ºäº†åœ¨æ¨é€æ—¶ä½¿ç”¨ GITHUB_TOKENï¼Œéœ€è¦å¼€å¯ fetch-depth 0 é¿å… Git shallow clone é—®é¢˜
          # å¦‚æœä½ çš„ä»“åº“ä¸æ˜¯åºå¤§ï¼Œä¸”ä¸å¤„ç†å¤§çš„ Git å†å²ï¼Œå¯ä»¥è®¾ç½®ä¸º0ï¼Œæˆ–æ ¹æ®éœ€è¦ä¼˜åŒ–ã€‚
          fetch-depth: 0 

      - name: ğŸŸ¢ Setup Node.js # ä½¿ç”¨æœ€æ–°ç‰ˆ setup-node
        uses: actions/setup-node@v4
        with:
          # ä½¿ç”¨å½“å‰çš„ LTS ç‰ˆæœ¬ï¼Œå¦‚ 20.x æˆ– 18.xã€‚é¿å… EOL ç‰ˆæœ¬ã€‚
          node-version: "20.x"
          cache: 'npm' # å¯ç”¨ npm ç¼“å­˜ï¼ŒåŠ å¿«ä¾èµ–å®‰è£…

      # åœ¨ä½¿ç”¨ `actions/setup-node` å¯ç”¨ cache: 'npm' åï¼Œä»¥ä¸‹ç‹¬ç«‹çš„ `actions/cache` æ­¥éª¤é€šå¸¸ä¸éœ€è¦äº†
      # å®ƒæ›´é€‚ç”¨äºè‡ªå®šä¹‰è·¯å¾„çš„ç¼“å­˜ã€‚ä½†å¦‚æœä½ æœ‰ç‰¹æ®Šç¼“å­˜éœ€æ±‚ï¼ˆå¦‚å…¶ä»–è·¯å¾„ï¼‰ï¼Œå¯ä¿ç•™ä½†éœ€æ›´æ–°ç‰ˆæœ¬ã€‚
      # é’ˆå¯¹ npm cacheï¼Œsetup-node å·²è¶³å¤Ÿã€‚
      # - name: ç¼“å­˜ Hexo
      #   uses: actions/cache@v4 # å‡çº§åˆ°v4
      #   id: cache # id å¯ä»¥æ›´å…·ä½“
      #   with:
      #     path: node_modules
      #     key: ${{runner.OS}}-npm-${{hashFiles('**/package-lock.json')}} # æ›´æ–° key å
      #     restore-keys: |
      #       ${{runner.OS}}-npm-

      - name: ğŸ“¦ Install npm dependencies # å°†å®‰è£… hexo-cli å’Œé¡¹ç›®ä¾èµ–æ”¾åœ¨ä¸€èµ·ï¼Œä¸”ç¡®ä¿æ¯æ¬¡éƒ½æ‰§è¡Œ npm install
                                         # å› ä¸º package-lock.json å¯èƒ½æ›´æ–°
        run: |
          npm install # `npm install hexo-cli -g` é€šå¸¸ä¸éœ€è¦ï¼Œå› ä¸º Hexo ä¼šä» package.json åŠ è½½
                      # å¦‚æœ hexo-cli æ˜¯é¡¹ç›®å¼€å‘ä¾èµ–ï¼Œnpm install å°±ä¼šå®‰è£…å®ƒã€‚
                      # å¦‚æœä½ éè¦å…¨å±€å®‰è£…ï¼Œå¯ä»¥åœ¨å‰é¢å•ç‹¬ä¸€æ­¥å®‰è£…ã€‚
          
      - name: âš™ï¸ Generate Hexo static files
        run: |
          hexo clean
          hexo generate # `hexo g` ä¹Ÿå¯ä»¥ï¼Œä½† `generate` æ›´æ¸…æ™°

      - name: ğŸš€ Deploy to GitHub Pages # éƒ¨ç½²éƒ¨åˆ†çš„æ ¸å¿ƒä¿®æ”¹
        run: |
          cd ./public # è¿›å…¥ Hexo ç”Ÿæˆçš„å…¬å…±ç›®å½•

          # è®¾ç½® Git ç”¨æˆ·èº«ä»½ä¿¡æ¯ã€‚éå¸¸å…³é”®ï¼Œä¸”æ”¾åœ¨ commit å‘½ä»¤ä¹‹å‰ã€‚
          # å»ºè®®ä½¿ç”¨ GitHub Actions Bot èº«ä»½ï¼Œæˆ–ä½ çš„ GitHub ç”¨æˆ·åã€‚
          # `secrets.GITHUBUSERNAME` å’Œ `secrets.GITHUBEMAIL` ä»å¯ç”¨ï¼Œå¦‚æœä½ çš„ Git é‚®ç®±å’Œåç§°å’Œ GitHub ä¸€è‡´
          git config user.name '${{ secrets.GITHUBUSERNAME || "github-actions[bot]" }}' # æä¾›é»˜è®¤å€¼æˆ– bot åç§°
          git config user.email '${{ secrets.GITHUBEMAIL || "41898282+github-actions[bot]@users.noreply.github.com" }}' # æä¾›é»˜è®¤å€¼æˆ– bot é‚®ç®±

          # è®¾ç½®é»˜è®¤åˆ†æ”¯åï¼ˆå¯é€‰ï¼Œä»…æ¶ˆé™¤æç¤ºï¼‰
          git config --global init.defaultBranch main

          git init # åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Git ä»“åº“åœ¨ public ç›®å½•ä¸­ (ç”¨äºéƒ¨ç½² Pages)
          
          git add . # æ·»åŠ æ‰€æœ‰æ›´æ”¹åˆ°æš‚å­˜åŒº

          # ä½¿ç”¨ä¸€ä¸ªæ›´å¯é çš„æäº¤æ¶ˆæ¯ï¼Œå¹¶è§£å†³å¯èƒ½ç”±äº ${{ github.event.head_commit.message }} ä¸ºç©ºå¯¼è‡´çš„é—®é¢˜
          commit_message="${{ github.event.head_commit.message }}"
          if [ -z "$commit_message" ]; then
              commit_message="Site updated by workflow from ${{ github.ref }}"
          fi
          # æ·»åŠ æ—¶é—´æˆ³åˆ° commit æ¶ˆæ¯ï¼Œè®©æ¯æ¬¡éƒ¨ç½²è®°å½•å”¯ä¸€ä¸”å¯è¿½è¸ª
          git commit -m "$commit_message ($(date +'%Y-%m-%d %H:%M:%S %Z'))" || true # `|| true` é˜²æ­¢åœ¨æ²¡æœ‰æ›´æ”¹æ—¶ä¸­æ–­
          
          # ---------- GitHub Pages éƒ¨ç½² URL å’Œè®¤è¯ ----------
          # æ¨èæ–¹æ³•ï¼šä½¿ç”¨ GitHub è‡ªåŠ¨æä¾›çš„ GITHUB_TOKEN
          # è¿™é€šå¸¸é€‚ç”¨äºéƒ¨ç½²åˆ°æœ¬ä»“åº“çš„ gh-pages æˆ– docs/ åˆ†æ”¯çš„ GitHub Pagesã€‚
          # repository URL for this approach: https://github.com/${{ github.repository }} (ä¼šè‡ªåŠ¨æ¨åˆ°æœ¬ä»“åº“)
          # æ³¨æ„ï¼š${{ github.repository }} ä¼šè§£æä¸º "owner/repo" (ä¾‹å¦‚ "your-username/your-blog-repo")
          
          # Push URL for PATs (secrets.GITHUBTOKEN, needs "repo" scope in PAT)
          # repository URL: "https://your_personal_token@github.com/your-username/your-username.github.io.git"
          
          # æ ¹æ®ä½ çš„ç›®æ ‡å’Œ secret çš„ç±»å‹é€‰æ‹©ã€‚
          # å¦‚æœä½ çš„ Pages ä»“åº“æ˜¯ YOURUSERNAME.github.io è¿™æ ·çš„ç‹¬ç«‹ä»“åº“ï¼Œéœ€è¦ä½¿ç”¨ PAT (GITHUBTOKEN)ã€‚
          # ä½ çš„ `secrets.GITHUBUSERNAME}/${{ secrets.GITHUBUSERNAME }}.github.io.git` åœ°å€å°±æ˜¯é’ˆå¯¹ç‹¬ç«‹ Pages ä»“åº“çš„
          
          # æ—§æ ¼å¼: https://${{ secrets.GITHUBUSERNAME }}:${{ secrets.GITHUBTOKEN }}@github.com/${{ secrets.GITHUBUSERNAME }}/${{ secrets.GITHUBUSERNAME }}.github.io.git
          # è¿™è¾¹ä¼šä½¿ç”¨ä½ çš„ secrets.GITHUBUSERNAME ä½œä¸ºç”¨æˆ·ï¼Œä»¥åŠ secrets.GITHUBTOKEN ä½œä¸ºå¯†ç /PAT
          # Git çš„æ—§åè®®å¯èƒ½å¯¹ `user:password@` æ ¼å¼æ›´å…¼å®¹ã€‚
          # å¯ä»¥ä½¿ç”¨è¿™ä¸ªï¼š
          git push --force --quiet "https://${{ secrets.GITHUBUSERNAME }}:${{ secrets.GITHUBTOKEN }}@github.com/${{ secrets.GITHUBUSERNAME }}/${{ secrets.GITHUBUSERNAME }}.github.io.git" master:master

          # æˆ–è€…ï¼Œå¦‚æœä½ ä¸æƒ³ç”¨ç”¨æˆ·å+ä»¤ç‰Œçš„æ—§æ ¼å¼ï¼Œç›´æ¥ä»¤ç‰Œè®¤è¯ã€‚æ›´æ¨èï¼š
          # Git é€šå¸¸ä¼šè‡ªåŠ¨è¯†åˆ«è¿™ç§æ ¼å¼ã€‚ä½ çš„ `secrets.GITHUBTOKEN` (å³ä½ çš„PAT) 
          # éœ€è¦ç›´æ¥æ”¾åœ¨ç”¨æˆ·éƒ¨åˆ†å‰é¢æˆ–è€…å†’å·åï¼Œå¹¶ä¸ä¸»æœºååˆ†éš”ã€‚
          # git push --force --quiet "https://oauth2:${{ secrets.GITHUBTOKEN }}@github.com/${{ secrets.GITHUBUSERNAME }}/${{ secrets.GITHUBUSERNAME }}.github.io.git" master:master
          # æˆ–ç®€åŒ–ä¸º (å¦‚æœPATå…è®¸)ï¼š
          # git push --force --quiet "https://${{ secrets.GITHUBTOKEN }}@github.com/${{ secrets.GITHUBUSERNAME }}/${{ secrets.GITHUBUSERNAME }}.github.io.git" master:master

          # ä½ é‡åˆ°çš„ `masterâ€â€‹â€â€‹â€â€â€â€‹â€Œâ€‹â€Œâ€Œâ€â€Œâ€‹â€Œâ€Œâ€` å­—ç¬¦é—®é¢˜
          # ç¡®ä¿è¿™é‡Œçš„ `master:master` æ˜¯æ‰‹åŠ¨è¾“å…¥çš„ï¼Œæ²¡æœ‰å¤šä½™çš„éšå½¢å­—ç¬¦ï¼
          # ï¼ˆå¦‚æœä½ æœ¬åœ°åšå®¢åˆ†æ”¯å« mainï¼Œéƒ¨ç½²åˆ†æ”¯å« gh-pagesï¼Œé‚£å°±æ˜¯ main:gh-pagesï¼‰
          
